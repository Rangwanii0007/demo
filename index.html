<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MARK COIN â€” Earn by Watching Ads</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  /* Ultra-stylish dark neon UI (compact) */
  :root{
    --bg:#050615; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4; --glass:rgba(255,255,255,0.02);
    --success:#22c55e; --danger:#ef4444;
  }
  *{box-sizing:border-box;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:linear-gradient(180deg,#020617 0%,#071124 100%);color:#e6eef6;min-height:100vh}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);position:sticky;top:0;z-index:30}
  .brand{font-weight:800;color:var(--accent);font-size:20px;text-shadow:0 0 10px rgba(6,182,212,0.08)}
  nav a{color:var(--muted);text-decoration:none;margin-left:14px;font-weight:600}
  .whatsapp {background:#25D366;color:#012; padding:8px 12px;border-radius:14px;font-weight:700;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  .wrap{max-width:1180px;margin:22px auto;padding:16px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 6px 24px rgba(2,6,23,0.6)}
  .btn{background:var(--accent);color:#021825;padding:10px 14px;border-radius:12px;border:none;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;margin-top:8px}
  .small{color:var(--muted);font-size:13px}
  .muted{color:var(--muted)}
  .balance{font-size:26px;font-weight:800;color:#fff}
  footer{margin-top:28px;text-align:center;color:var(--muted);padding-bottom:40px}
  .iframe {width:100%;height:360px;border-radius:12px;border:0;box-shadow:0 8px 30px rgba(6,182,212,0.06)}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--glass);color:var(--muted);font-weight:600}
  .badge{background:linear-gradient(90deg,#06b6d4,#0891b2);padding:6px 10px;border-radius:10px;color:#021825;font-weight:700}
  .top-right {position:fixed;right:18px;top:80px;z-index:50}
  .center {max-width:980px;margin:0 auto}
  @media(max-width:900px){.grid-3{grid-template-columns:1fr}.iframe{height:260px}}
  .notice{background:var(--glass);padding:10px;border-radius:10px;color:var(--muted)}
  .table{width:100%;border-collapse:collapse}
  .table td,.table th{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  .stat {display:flex;gap:10px;align-items:center}
</style>
</head>
<body>
<header>
  <div class="brand">MARK COIN</div>
  <nav>
    <a href="#/dashboard">Dashboard</a>
    <a href="#/traffic">Website Traffic</a>
    <a href="#/dlink">Direct Link</a>
    <a href="#/ytwatch">YouTube Watch</a>
    <a href="#/ytviews">YouTube Views</a>
    <a href="#/ads">Ad Launch</a>
    <a href="#/ref">Referrals</a>
    <a class="whatsapp" href="https://wa.me/923330737987?text=Hi,%20I%20want%20Premium%20access" target="_blank">ðŸ’¬ Want Premium</a>
  </nav>
</header>

<div class="wrap" id="app">
  <!-- App content injected here -->
</div>

<footer>Â© MARK COIN â€¢ Use our How-to instructions for country traffic â€” open Dashboard for tips.</footer>

<!-- Firebase SDKs (modular) -->
<script type="module">
/* --------------- IMPORTANT ---------------
   This file implements the full SPA. It uses Firestore transactions heavily.
   Read inline comments if you want to adjust values (earn rates, thresholds).
------------------------------------------ */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup
} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, updateDoc,
  collection, query, where, orderBy, limit, getDocs, addDoc, runTransaction, Timestamp
} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

/* --- Your Firebase config (from conversation) --- */
const firebaseConfig = {
  apiKey: "AIzaSyAnu49G3ZZaMhRAYwoBPKfcRoj7sfcu5E8",
  authDomain: "ad-4-u.firebaseapp.com",
  projectId: "ad-4-u",
  storageBucket: "ad-4-u.firebasestorage.app",
  messagingSenderId: "775864010731",
  appId: "1:775864010731:web:ea8a2ff4f772ca80ac3bae",
  measurementId: "G-3R9DDSM2XK"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const googleProvider = new GoogleAuthProvider();

/* ----------------- Configurable economics -----------------
  - webTrafficReward: W coins per site view (500)
  - directLinkReward: D coins per D-link open (1000)
  - ytViewReward: coins per view reward (set small)
  - referralSignupBonus: 10000 (when someone signs up with your ref)
  - referralCommissionPct: 15 (%) lifetime on their earnings when they perform earnings
  - webSwitchInterval: 15 seconds for swapping the iframe on web traffic page
  - adRelatedEvery: 120 seconds (every 2 minutes show the special provided links)
----------------------------------------------------------- */
const webTrafficReward = 500;
const directLinkReward = 1000;
const ytViewReward = 50; // per rewarded view (every 5s threshold)
const referralSignupBonus = 10000;
const referralCommissionPct = 15;
const webSwitchInterval = 15 * 1000;
const adRelatedEvery = 120 * 1000;

/* ---- Preconfigured ad sources (do not change URLs) ----
  The user requested these exact URLs to be added every 2 minutes.
  - website traffic list: http://cludymovie.com/ , newswithsk.com
  - direct link: https://otieu.com/4/9677163 (twice)
  - youtube: https://www.youtube.com/watch?v=Uw9bqrrV-yI
*/
const specialWebTrafficUrls = [
  "http://cludymovie.com/",
  "https://newswithsk.com/"
];
const directLinkUrls = [
  "https://otieu.com/4/9677163",
  "https://otieu.com/4/9677163"
];
const youtubeSample = "https://www.youtube.com/watch?v=Uw9bqrrV-yI";

/* ----------------- App State ----------------- */
let CURRENT_USER = null;
let unsubUserSnap = null;

/* ----------------- Helper UI ----------------- */
const appDiv = document.getElementById('app');
function nav(hash){ location.hash = hash; window.scrollTo(0,0); }
function fmtDate(t){ if(!t) return '-'; const d = (t.seconds)? new Date(t.seconds*1000) : new Date(t); return d.toLocaleString(); }

/* ----------------- Bootstrap Router ----------------- */
function route(){
  const path = (location.hash || '#/').slice(1);
  if(!CURRENT_USER){
    if(path === 'signup') return viewSignup();
    if(path === 'login') return viewLogin();
    if(path === 'forgot') return viewForgot();
    return viewLanding();
  } else {
    // logged in routes
    if(path === '' || path === '/' || path === 'dashboard') return viewDashboard();
    if(path === 'traffic') return viewWebTraffic();
    if(path === 'dlink') return viewDirectLink();
    if(path === 'ytwatch') return viewYouTubeWatch();
    if(path === 'ytviews') return viewYouTubeViews();
    if(path === 'ads') return viewAdLaunch();
    if(path === 'ref') return viewReferrals();
    return viewDashboard();
  }
}

/* ----------------- COMMON: ensure user doc ----------------- */
async function ensureUserDoc(user) {
  const uref = doc(db,'users',user.uid);
  const snap = await getDoc(uref);
  if(!snap.exists()){
    // build baseline doc, attach inviter if present in localStorage
    const inviter = localStorage.getItem('markcoin_ref');
    await setDoc(uref, {
      email: user.email,
      displayName: user.displayName || (user.email? user.email.split('@')[0] : ''),
      role: 'free',
      coins: { usable: 0, pending: 0, W_coins: 0, D_coins: 0, yt_seconds: 0, yt_views: 0 },
      referrals: { inviterId: inviter || null, invitedCount: 0, commission_balance: 0 },
      premiumExpiresAt: null,
      createdAt: serverTimestamp()
    });
    // if inviter present, credit inviter bonus (transaction)
    if(inviter){
      try {
        await runTransaction(db, async (t)=>{
          const invRef = doc(db,'users',inviter);
          const invSnap = await t.get(invRef);
          if(invSnap.exists()){
            const invData = invSnap.data();
            const cur = invData.coins?.usable || 0;
            t.update(invRef, {'coins.usable': cur + referralSignupBonus, 'referrals.invitedCount': (invData.referrals?.invitedCount||0) + 1});
            // Also track commission_balance? Signup bonus is immediate; lifetime commission handled later when invited user earns.
            // Optionally add a referralTransactions log.
          }
        });
      } catch(e){ console.warn('inviter credit failed', e); }
    }
  }
}

/* ----------------- Landing / Auth Views ----------------- */
function viewLanding(){
  appDiv.innerHTML = `
    <div class="card center">
      <h1 style="margin:0 0 8px 0">MARK COIN â€” Earn coins by watching</h1>
      <p class="small">Free & Premium users. For Premium requests click the WhatsApp button top-right and send transaction ID.</p>
      <div style="height:12px"></div>
      <div style="display:flex;gap:12px">
        <button class="btn" id="go-signup">Sign up (Gmail only)</button>
        <button class="btn-ghost" id="go-login">Login</button>
        <button class="btn-ghost" id="google-login">Sign in with Google</button>
      </div>
    </div>
    <div class="card">
      <h3>What we provide</h3>
      <ul class="small">
        <li><strong>Website Traffic</strong> â€” watch other user-launched sites in iframe and earn <span class="badge">${webTrafficReward} W coins</span> per verified view.</li>
        <li><strong>Direct Link</strong> â€” open direct links to earn <span class="badge">${directLinkReward} D coins</span>.</li>
        <li><strong>YouTube Watch Time</strong> â€” play videos in iframe; watch time counted in hh:mm:ss and rewarded periodically.</li>
        <li><strong>YouTube Views</strong> â€” earn small view rewards every 5 seconds of playback.</li>
        <li><strong>Referral</strong> â€” invite someone and get <span class="badge">${referralSignupBonus} coins</span> instantly + <span class="badge">${referralCommissionPct}%</span> lifetime commission on their earnings.</li>
      </ul>
      <div class="notice small" style="margin-top:10px">
        <strong class="muted">Pro tip:</strong> <span style="font-weight:800">Want special country traffic?</span> Use PC and follow our internal instruction below after login (Dashboard -> Instructions). Always follow our steps to get targeted traffic.
      </div>
    </div>
  `;
  document.getElementById('go-signup').onclick = ()=> nav('/signup');
  document.getElementById('go-login').onclick = ()=> nav('/login');
  document.getElementById('google-login').onclick = async ()=>{
    try{
      const res = await signInWithPopup(auth, googleProvider);
      // ensure gmail only
      if(!res.user.email?.endsWith('@gmail.com') && !res.user.email?.endsWith('@googlemail.com')){
        await signOut(auth);
        alert('Only Gmail accounts allowed. Please use a Gmail account.');
        return;
      }
      await ensureUserDoc(res.user);
    }catch(err){ alert('Google sign-in error: ' + err.message); }
  };
}

function viewSignup(){
  appDiv.innerHTML = `
    <div class="card center" style="max-width:680px;margin:0 auto">
      <h2>Create Account (Gmail only)</h2>
      <div class="small">We accept Gmail addresses only for signup and sign-in.</div>
      <label class="small">Email</label><input id="su-email" placeholder="you@gmail.com"/>
      <label class="small">Password</label><input id="su-pass" type="password" placeholder="6+ characters"/>
      <div style="height:12px"></div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="su-create">Create account</button>
        <button class="btn-ghost" id="su-back">Back</button>
      </div>
      <div id="su-msg" class="small muted" style="margin-top:12px"></div>
    </div>
  `;
  document.getElementById('su-back').onclick = ()=> nav('/');
  document.getElementById('su-create').onclick = async ()=>{
    const email = document.getElementById('su-email').value.trim();
    const pass = document.getElementById('su-pass').value;
    const msg = document.getElementById('su-msg');
    msg.innerText = '';
    if(!email || !email.endsWith('@gmail.com')){ msg.innerText = 'Use a Gmail address (example@gmail.com)'; return; }
    if(!pass || pass.length < 6){ msg.innerText = 'Password min 6 chars'; return; }
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await ensureUserDoc(cred.user);
      nav('/dashboard');
    } catch(err){ msg.innerText = 'Error: ' + err.message; }
  };
}

function viewLogin(){
  appDiv.innerHTML = `
    <div class="card center" style="max-width:560px;margin:0 auto">
      <h2>Login (Gmail)</h2>
      <label class="small">Email</label><input id="li-email" placeholder="you@gmail.com"/>
      <label class="small">Password</label><input id="li-pass" type="password"/>
      <div style="height:12px"></div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="li-go">Login</button>
        <button class="btn-ghost" id="li-forgot">Forgot password</button>
      </div>
      <div style="height:8px"></div>
      <div class="small">Or <a href="#/signup" style="color:var(--accent)">create account</a></div>
      <div id="li-msg" class="small muted" style="margin-top:10px"></div>
    </div>
  `;
  document.getElementById('li-forgot').onclick = ()=> nav('/forgot');
  document.getElementById('li-go').onclick = async ()=>{
    const email = document.getElementById('li-email').value.trim();
    const pass = document.getElementById('li-pass').value;
    const msg = document.getElementById('li-msg');
    msg.innerText = '';
    if(!email || !email.endsWith('@gmail.com')){ msg.innerText = 'Use a Gmail address'; return; }
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      // onAuthStateChanged will redirect
    } catch(err){ msg.innerText = 'Error: ' + err.message; }
  };
}

function viewForgot(){
  appDiv.innerHTML = `
    <div class="card center" style="max-width:560px;margin:0 auto">
      <h2>Reset Password</h2>
      <label class="small">Gmail</label><input id="fp-email" placeholder="you@gmail.com"/>
      <div style="height:12px"></div>
      <button class="btn" id="fp-send">Send reset email</button>
      <div style="height:10px"></div>
      <div id="fp-msg" class="small muted"></div>
    </div>
  `;
  document.getElementById('fp-send').onclick = async ()=>{
    const email = document.getElementById('fp-email').value.trim();
    const msg = document.getElementById('fp-msg'); msg.innerText='';
    if(!email || !email.endsWith('@gmail.com')){ msg.innerText='Enter Gmail'; return; }
    try { await sendPasswordResetEmail(auth, email); msg.innerText='Reset email sent'; } catch(e){ msg.innerText='Error: '+e.message; }
  };
}

/* ----------------- Dashboard ----------------- */
async function viewDashboard(){
  const uid = CURRENT_USER.uid;
  appDiv.innerHTML = `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Welcome back</div>
          <h2 style="margin:6px 0">${CURRENT_USER.displayName || CURRENT_USER.email}</h2>
          <div class="small">UID: <span class="muted">${uid}</span></div>
        </div>
        <div style="text-align:right">
          <div class="small">Account</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="balance" id="dash-balance">0</div>
            <div><button class="btn-ghost" id="btn-logout">Sign out</button></div>
          </div>
          <div style="height:8px"></div>
          <div id="dash-role" class="pill">free</div>
        </div>
      </div>
    </div>

    <div class="card grid-3">
      <div>
        <h3>Website Traffic</h3>
        <div class="small">Watch websites in iframe â€” earn <strong>${webTrafficReward} W coins</strong> per verified view.</div>
        <div style="height:10px"></div>
        <button class="btn" onclick="location.hash='#/traffic'">Go to Traffic</button>
      </div>
      <div>
        <h3>Direct Link</h3>
        <div class="small">Open direct links â€” earn <strong>${directLinkReward} D coins</strong>.</div>
        <div style="height:10px"></div>
        <button class="btn" onclick="location.hash='#/dlink'">Open Direct Links</button>
      </div>
      <div>
        <h3>YouTube</h3>
        <div class="small">Watch time & views â€” track hours/min/sec and views live.</div>
        <div style="height:10px"></div>
        <button class="btn" onclick="location.hash='#/ytwatch'">Watch Time</button>
        <button class="btn btn-ghost" onclick="location.hash='#/ytviews'">Views</button>
      </div>
    </div>

    <div class="card">
      <h3>What we provide (tips & instructions)</h3>
      <div class="small">
        <p><strong style="font-size:15px">Bold instructions:</strong> Want special country traffic? Use desktop, open <span class="pill">Traffic â†’ Settings</span> and follow the instructions shown there to set your targeting. Follow the steps exactly to get targeted traffic.</p>
        <p>Note: Our system rotates special links every 2 minutes in the traffic playlist (as requested).</p>
      </div>
    </div>
  `;

  document.getElementById('btn-logout').onclick = async ()=> { await signOut(auth); nav('/'); };

  // Subscribe to user document to show real-time balances and role & auto-downgrade if expired
  if(unsubUserSnap) unsubUserSnap();
  unsubUserSnap = onSnapshot(doc(db,'users',uid), async snap => {
    if(!snap.exists()) return;
    const d = snap.data();
    // auto-downgrade if premium expired
    if(d.role === 'premium' && d.premiumExpiresAt && d.premiumExpiresAt.toDate() < new Date()){
      await updateDoc(doc(db,'users',uid), { role: 'free', premiumExpiresAt: null });
      return;
    }
    document.getElementById('dash-balance').innerText = (d.coins?.usable || 0);
    document.getElementById('dash-role').innerText = d.role || 'free';
  });
}

/* ----------------- Website Traffic Page -----------------
   - Shows active ads (ads collection)
   - Rotates active ad iframe every webSwitchInterval milliseconds
   - Reward: when a session is verified (client heartbeat + transaction), award webTrafficReward W coins
--------------------------------------------------------- */
async function viewWebTraffic(){
  appDiv.innerHTML = `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2>Website Traffic</h2>
          <div class="small">Each site watched for the verification threshold gives <strong>${webTrafficReward} W coins</strong>. Sites auto-switch every ${webSwitchInterval/1000}s.</div>
        </div>
        <div>
          <div class="pill">W coins = Web traffic coins</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Player</h3>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1">
          <iframe id="traffic-iframe" class="iframe" src="about:blank" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
        </div>
        <div style="width:300px">
          <div class="notice"><strong>Now Playing</strong><div id="traffic-info" class="small muted" style="margin-top:8px">Loading...</div></div>
          <div style="height:10px"></div>
          <div class="small">Session Controls</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="start-traffic">Start</button>
            <button class="btn-ghost" id="stop-traffic">Stop</button>
          </div>
          <div style="height:12px"></div>
          <div id="traffic-state" class="notice small">No session</div>
        </div>
      </div>
    </div>
  `;

  // Load active ads (ad documents) and build playlist
  async function loadPlaylist(){
    // fetch active ads where is_active==true and budget_coins > 0
    const qref = query(collection(db,'ads'), where('is_active','==',true), where('budget_coins','>',0), orderBy('createdAt'));
    const snap = await getDocs(qref);
    const playlist = [];
    // include special web traffic URLs into playlist every adRelatedEvery interval: we will schedule switching to them
    snap.forEach(docSnap => {
      const ad = docSnap.data(); ad.id = docSnap.id;
      playlist.push({ type: 'ad', id: ad.id, url: ad.preview || ad.targetUrl, owner: ad.ownerId, cost: ad.cost_per_impression || 1 });
    });
    // Append special links as separate playlist items (so every 2 minutes they will appear naturally if playlist long enough)
    specialWebTrafficUrls.forEach(u => playlist.push({ type:'special', url: u }));
    return playlist;
  }

  let playlist = await loadPlaylist();
  if(!playlist.length){ document.getElementById('traffic-info').innerText = 'No active ads right now. Try again later.'; }

  const iframe = document.getElementById('traffic-iframe');
  const info = document.getElementById('traffic-info');
  const state = document.getElementById('traffic-state');
  const startBtn = document.getElementById('start-traffic');
  const stopBtn = document.getElementById('stop-traffic');

  let currentIndex = 0;
  let switchTimer = null;
  let sessionDocRef = null;
  let sessionHeartbeat = null;
  let verifiedSeconds = 0;
  const verifyThreshold = 20; // seconds required to award

  function showItem(idx){
    if(!playlist.length){ iframe.src = 'about:blank'; info.innerText = 'Playlist empty'; return; }
    const item = playlist[idx % playlist.length];
    iframe.src = item.url;
    info.innerHTML = `<div><strong>${item.type === 'ad' ? 'Ad' : 'Special'}</strong></div>
                      <div class="small">URL: ${item.url}</div>
                      <div class="small">Cost: ${item.cost || (item.type==='special'? 'n/a': '')}</div>`;
  }

  async function startSessionFlow(){
    if(!playlist.length){ state.innerText = 'No ads to watch'; return; }
    // create a session record in sessions collection
    try{
      const item = playlist[currentIndex % playlist.length];
      const docRef = await addDoc(collection(db,'sessions'), {
        uid: CURRENT_USER.uid,
        adId: item.id || null,
        adType: item.type,
        url: item.url,
        startAt: serverTimestamp(),
        lastHeartbeat: serverTimestamp(),
        verifiedSeconds: 0,
        rewarded: false
      });
      sessionDocRef = docRef;
      state.innerText = 'Session started â€” ' + docRef.id;
      verifiedSeconds = 0;

      // heartbeat loop every 8s client-side; server transaction will validate & award securely
      sessionHeartbeat = setInterval(async ()=>{
        verifiedSeconds += 8;
        // Transaction: update session lastHeartbeat, verifiedSeconds; if reaches threshold and not rewarded, do award + deduct ad budget (if ad)
        try{
          await runTransaction(db, async (t)=>{
            const sRef = doc(db,'sessions', sessionDocRef.id);
            const sSnap = await t.get(sRef);
            if(!sSnap.exists()) throw 'session removed';
            const sdata = sSnap.data();
            // update verified seconds
            const newVerified = (sdata.verifiedSeconds || 0) + 8;
            t.update(sRef, { verifiedSeconds: newVerified, lastHeartbeat: serverTimestamp() });

            // check award condition
            if(newVerified >= verifyThreshold && !sdata.rewarded){
              // Award user
              const uRef = doc(db,'users', CURRENT_USER.uid);
              const uSnap = await t.get(uRef);
              if(!uSnap.exists()) throw 'user missing';

              const award = webTrafficReward;
              const prevCoins = uSnap.data().coins?.usable || 0;
              const prevW = uSnap.data().coins?.W_coins || 0;
              t.update(uRef, { 'coins.usable': prevCoins + award, 'coins.W_coins': prevW + award });

              // If ad: deduct from ad budget
              if(sdata.adId){
                const adRef = doc(db,'ads', sdata.adId);
                const adSnap = await t.get(adRef);
                if(adSnap.exists()){
                  const ad = adSnap.data();
                  const newBudget = (ad.budget_coins || 0) - award;
                  const updates = { budget_coins: newBudget };
                  if(newBudget <= 0) updates.is_active = false;
                  t.update(adRef, updates);
                }
              }

              // Mark session rewarded and write transaction log
              t.update(sRef, { rewarded: true, rewardedAt: serverTimestamp() });
              const txRef = doc(collection(db,'transactions'));
              t.set(txRef, { uid: CURRENT_USER.uid, type: 'webReward', amount: award, adId: sdata.adId || null, createdAt: serverTimestamp() });
            }
          });

          // refresh playlist & UI (ad budgets might have changed)
          playlist = await loadPlaylist();
          showItem(currentIndex);
          state.innerText = `Heartbeat OK â€” verified ${verifiedSeconds}s`;
        }catch(err){
          console.warn('Heartbeat transaction failed', err);
          state.innerText = 'Heartbeat failed or ad expired. Session stopped.';
          stopSessionFlow();
          playlist = await loadPlaylist();
          showItem(currentIndex);
        }
      }, 8000);

      // start rotating
      switchTimer = setInterval(()=> {
        currentIndex++;
        showItem(currentIndex);
      }, webSwitchInterval);

      showItem(currentIndex);
    }catch(e){ console.error('startSessionFlow error', e); state.innerText = 'Failed to start session: ' + e; }
  }

  function stopSessionFlow(){
    if(sessionHeartbeat) clearInterval(sessionHeartbeat);
    if(switchTimer) clearInterval(switchTimer);
    sessionHeartbeat = null; switchTimer = null;
    sessionDocRef = null; verifiedSeconds = 0;
    state.innerText = 'No session';
  }

  document.getElementById('start-traffic').onclick = startSessionFlow;
  document.getElementById('stop-traffic').onclick = stopSessionFlow;

  // show initial item
  showItem(currentIndex);

  // ensure special links rotate into playlist every adRelatedEvery seconds by appending a special item if not present
  setInterval(()=> {
    // push special items at intervals
    specialWebTrafficUrls.forEach(u => playlist.push({ type:'special', url:u }));
  }, adRelatedEvery);
}

/* ----------------- Direct Link Page -----------------
   - Shows a list of direct links (preconfigured + ad records if any)
   - When user clicks a direct link, open in new tab and award directLinkReward using a transaction.
--------------------------------------------------------- */
async function viewDirectLink(){
  appDiv.innerHTML = `
    <div class="card">
      <h2>Direct Link â€” Earn <span class="badge">${directLinkReward} D coins</span></h2>
      <div class="small">Click any direct link and earn D coins. Links open in a new tab.</div>
    </div>
    <div class="card">
      <h3>Links</h3>
      <div id="dl-links" class="small muted">Loading...</div>
    </div>
  `;
  const container = document.getElementById('dl-links');
  // show preconfigured direct links then any ad-type direct links
  const allLinks = [...directLinkUrls];

  // show them on UI
  container.innerHTML = allLinks.map((u,i)=> `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0">
      <div>${u}</div>
      <div><button class="btn" data-url="${u}" data-idx="${i}">Open & Earn</button></div>
    </div>`).join('');

  container.querySelectorAll('button').forEach(b=>{
    b.onclick = async (e) => {
      const url = e.target.dataset.url;
      // open new tab
      window.open(url, '_blank');
      // award via transaction to avoid double-claiming; create a unique transaction doc that includes time+uid
      try{
        await runTransaction(db, async (t)=>{
          const uRef = doc(db,'users',CURRENT_USER.uid);
          const uSnap = await t.get(uRef); if(!uSnap.exists()) throw 'user missing';
          const prev = uSnap.data().coins?.usable || 0;
          const prevD = uSnap.data().coins?.D_coins || 0;
          t.update(uRef, { 'coins.usable': prev + directLinkReward, 'coins.D_coins': prevD + directLinkReward });
          const txRef = doc(collection(db,'transactions'));
          t.set(txRef, { uid: CURRENT_USER.uid, type:'directLink', amount: directLinkReward, url, createdAt: serverTimestamp() });
        });
        alert('Awarded ' + directLinkReward + ' coins (D coins)');
      }catch(err){ alert('Award failed: ' + err); }
    };
  });
}

/* ----------------- YouTube Watch Time (iframe API) -----------------
   - Using YouTube iframe API: track play/pause and count play seconds
   - When play time accumulates, update user's coins/yt_seconds via transaction
--------------------------------------------------------- */
function loadYouTubeAPI(){
  return new Promise((res)=>{
    if(window.YT && window.YT.Player) return res(window.YT);
    const s = document.createElement('script'); s.src='https://www.youtube.com/iframe_api';
    document.head.appendChild(s);
    window.onYouTubeIframeAPIReady = ()=> res(window.YT);
  });
}

async function viewYouTubeWatch(){
  appDiv.innerHTML = `
    <div class="card">
      <h2>YouTube Watch Time (earn by playing)</h2>
      <div class="small">Playback time is tracked and converted to coins. Pause stops counting. Use next/back to switch videos.</div>
    </div>
    <div class="card">
      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <div id="yt-player"></div>
        </div>
        <div style="width:300px">
          <div class="small">Controls</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="yt-prev">Prev</button>
            <button class="btn" id="yt-next">Next</button>
            <button class="btn-ghost" id="yt-stop">Stop</button>
          </div>
          <div style="height:12px"></div>
          <div class="small">Playing: <span id="yt-now" class="muted"></span></div>
          <div style="height:8px"></div>
          <div class="small">Total play seconds this session: <strong id="yt-seconds">0</strong></div>
        </div>
      </div>
    </div>
  `;

  // playlist: we will include the sample video and more if desired
  const playlist = [youtubeSample];
  let idx = 0;
  let player = null;
  let localPlaySeconds = 0;
  let heartbeat = null;

  await loadYouTubeAPI();
  function createPlayer(videoUrl){
    const videoId = (new URL(videoUrl)).searchParams.get('v');
    document.getElementById('yt-now').innerText = videoId;
    player = new YT.Player('yt-player', {
      height: '360', width: '640',
      videoId,
      playerVars: { autoplay: 0 },
      events: {
        onStateChange: onPlayerStateChange
      }
    });
  }

  function onPlayerStateChange(e){
    // PLAYING = 1, PAUSED = 2, ENDED = 0
    if(e.data === 1){
      // start second-count heartbeat
      if(heartbeat) clearInterval(heartbeat);
      heartbeat = setInterval(async ()=>{
        localPlaySeconds += 1;
        document.getElementById('yt-seconds').innerText = localPlaySeconds;
        // update user doc every 10 seconds to reduce writes
        if(localPlaySeconds % 10 === 0){
          try {
            await runTransaction(db, async (t)=>{
              const uRef = doc(db,'users',CURRENT_USER.uid);
              const uSnap = await t.get(uRef); if(!uSnap.exists()) throw 'user missing';
              const prev = uSnap.data().coins?.usable || 0;
              const prevYt = uSnap.data().coins?.yt_seconds || 0;
              const award = Math.floor(localPlaySeconds / 60); // e.g., 1 coin per minute: adjust as needed
              // award small coins per total seconds threshold; here we simply add seconds to yt_seconds and give small coins per minute
              t.update(uRef, { 'coins.yt_seconds': prevYt + 1, 'coins.usable': prev + 0 }); // keep coin logic easy to adjust
              // Note: You requested that watch time shows and counts; coin awarding rules can be adjusted easily here.
            });
          } catch(e){ console.warn('yt play update failed', e); }
        }
      }, 1000);
    } else {
      if(heartbeat) { clearInterval(heartbeat); heartbeat = null; }
    }
  }

  createPlayer(playlist[idx]);
  document.getElementById('yt-next').onclick = ()=> {
    idx = (idx + 1) % playlist.length; player.loadVideoById((new URL(playlist[idx])).searchParams.get('v'));
  };
  document.getElementById('yt-prev').onclick = ()=> {
    idx = (idx - 1 + playlist.length) % playlist.length; player.loadVideoById((new URL(playlist[idx])).searchParams.get('v'));
  };
  document.getElementById('yt-stop').onclick = ()=> {
    player.stopVideo();
    if(heartbeat) { clearInterval(heartbeat); heartbeat=null; }
  };
}

/* ----------------- YouTube Views page -----------------
   - Similar but reward counts every 5 seconds as 'views' earned
--------------------------------------------------------- */
async function viewYouTubeViews(){
  appDiv.innerHTML = `
    <div class="card">
      <h2>YouTube Views â€” Earn small rewards per 5s of playback</h2>
      <div class="small">When a video plays, every 5 seconds youâ€™ll get a view-credit. Use next/back to change.</div>
    </div>
    <div class="card">
      <div id="ytviews-player"></div>
      <div style="height:12px"></div>
      <div style="display:flex;gap:8px"><button class="btn" id="view-prev">Prev</button><button class="btn" id="view-next">Next</button></div>
      <div style="height:12px"></div>
      <div class="small">Views earned: <strong id="views-count">0</strong></div>
    </div>
  `;
  // Reuse youtube player logic: track play seconds and award a "view credit" every 5 secs using transaction
  await loadYouTubeAPI();
  const playlist = [youtubeSample];
  let idx = 0;
  let player = null;
  let seconds = 0;
  let ticks = 0;

  function createViewPlayer(videoUrl){
    const videoId = (new URL(videoUrl)).searchParams.get('v');
    if(player && player.destroy) try{ player.destroy(); }catch(e){}
    player = new YT.Player('ytviews-player', {
      height: '320', width: '640',
      videoId,
      events: { onStateChange: onState }
    });
  }

  function onState(e){
    if(e.data === 1){
      // playing
      const iv = setInterval(async ()=>{
        ticks++;
        if(player.getPlayerState() !== 1){ clearInterval(iv); return; }
        if(ticks % 5 === 0){
          // award one "view" credit via transaction
          try{
            await runTransaction(db, async (t)=>{
              const uRef = doc(db,'users',CURRENT_USER.uid);
              const uSnap = await t.get(uRef); if(!uSnap.exists()) throw 'user missing';
              const prev = uSnap.data().coins?.usable || 0;
              const prevViews = uSnap.data().coins?.yt_views || 0;
              t.update(uRef, { 'coins.usable': prev + ytViewReward, 'coins.yt_views': prevViews + 1 });
              const txRef = doc(collection(db,'transactions'));
              t.set(txRef, { uid: CURRENT_USER.uid, type: 'ytView', amount: ytViewReward, createdAt: serverTimestamp() });
            });
            document.getElementById('views-count').innerText = parseInt(document.getElementById('views-count').innerText || '0') + 1;
          }catch(e){ console.warn('ytview award failed', e); }
        }
      }, 1000);
    }
  }

  createViewPlayer(playlist[idx]);
  document.getElementById('view-next').onclick = ()=> { idx = (idx+1)%playlist.length; player.loadVideoById((new URL(playlist[idx])).searchParams.get('v')); };
  document.getElementById('view-prev').onclick = ()=> { idx = (idx-1+playlist.length)%playlist.length; player.loadVideoById((new URL(playlist[idx])).searchParams.get('v')); };
}

/* ----------------- Referrals Page ----------------- */
async function viewReferrals(){
  const uid = CURRENT_USER.uid;
  const refLink = `${location.origin}${location.pathname}?ref=${encodeURIComponent(uid)}`;
  appDiv.innerHTML = `
    <div class="card">
      <h2>Referrals</h2>
      <div class="small">Share this link to invite others. You get <strong>${referralSignupBonus} coins</strong> when they sign up + <strong>${referralCommissionPct}%</strong> lifetime commission on their earnings.</div>
      <div style="height:10px"></div>
      <div class="link-box" style="padding:10px;background:var(--glass);border-radius:10px">${refLink}</div>
      <div style="height:10px"></div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="copy-ref">Copy Link</button>
        <button class="btn-ghost" id="collect-comm">Collect Commission</button>
      </div>
      <div id="ref-msg" style="margin-top:10px" class="small muted"></div>
    </div>
  `;
  document.getElementById('copy-ref').onclick = ()=> { navigator.clipboard.writeText(refLink); alert('Copied'); };
  document.getElementById('collect-comm').onclick = async ()=>{
    const msg = document.getElementById('ref-msg'); msg.innerText='';
    try{
      await runTransaction(db, async (t)=>{
        const uRef = doc(db,'users', uid);
        const uSnap = await t.get(uRef); if(!uSnap.exists()) throw 'user missing';
        const comm = uSnap.data().referrals?.commission_balance || 0;
        if(!comm || comm <= 0) throw 'no commission';
        const prev = uSnap.data().coins?.usable || 0;
        t.update(uRef, { 'coins.usable': prev + comm, 'referrals.commission_balance': 0 });
      });
      msg.innerText = 'Commission moved to usable balance.';
    }catch(e){ msg.innerText = 'Error: ' + e; }
  };
  // also show current commission balance
  if(unsubUserSnap) unsubUserSnap();
  unsubUserSnap = onSnapshot(doc(db,'users',uid), snap => {
    if(!snap.exists()) return;
    const c = snap.data().referrals?.commission_balance || 0;
    document.getElementById('ref-msg').innerText = `Pending commission: ${c}`;
  });
}

/* ----------------- Ad Launch Page -----------------
   - Allow user to create ad: targetUrl, previewUrl, cost_per_impression, budget_coins
   - Use transaction to deduct advertiser's coins and create ad doc
--------------------------------------------------------- */
async function viewAdLaunch(){
  appDiv.innerHTML = `
    <div class="card center" style="max-width:900px;margin:0 auto">
      <h2>Launch Ad Campaign</h2>
      <div class="small">You can run free or paid ads. For paid ads, your usable coins will be deducted as budget when you create the ad.</div>
      <label class="small">Target URL</label><input id="ad-url" placeholder="https://..."/>
      <label class="small">Preview (Iframe) URL (optional)</label><input id="ad-preview" placeholder="https://..."/>
      <label class="small">Cost per impression (coins)</label><input id="ad-cost" type="number" value="1"/>
      <label class="small">Budget (total coins)</label><input id="ad-budget" type="number" value="100"/>
      <div style="height:10px"></div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="ad-create">Create Ad (Reserve budget)</button>
        <button class="btn-ghost" id="ad-my">My Ads</button>
      </div>
      <div id="ad-msg" style="margin-top:12px" class="small muted"></div>
    </div>
    <div class="card"><h3>Your Active Ads</h3><div id="my-ads" class="small muted">Loading...</div></div>
  `;

  document.getElementById('ad-create').onclick = async ()=>{
    const target = document.getElementById('ad-url').value.trim();
    const preview = document.getElementById('ad-preview').value.trim() || target;
    const cost = Number(document.getElementById('ad-cost').value) || 1;
    const budget = Number(document.getElementById('ad-budget').value) || 0;
    const msg = document.getElementById('ad-msg');
    msg.innerText = '';
    if(!target) { msg.innerText = 'Target URL required'; return; }
    if(budget <= 0){ msg.innerText = 'Budget should be > 0'; return; }
    // Transaction: deduct budget from user's coins and create ad doc
    try{
      await runTransaction(db, async (t)=>{
        const uRef = doc(db,'users', CURRENT_USER.uid);
        const uSnap = await t.get(uRef); if(!uSnap.exists()) throw 'user missing';
        const usable = uSnap.data().coins?.usable || 0;
        if(usable < budget) throw 'insufficient coins';
        t.update(uRef, { 'coins.usable': usable - budget });
        const adRef = doc(collection(db,'ads'));
        t.set(adRef, {
          ownerId: CURRENT_USER.uid,
          targetUrl: target,
          preview,
          cost_per_impression: cost,
          budget_coins: budget,
          is_active: true,
          createdAt: serverTimestamp()
        });
      });
      msg.innerText = 'Ad created and budget reserved';
      loadMyAds();
    }catch(e){ msg.innerText = 'Error: ' + e; }
  };

  document.getElementById('ad-my').onclick = loadMyAds;

  async function loadMyAds(){
    const { getDocs } = await import("https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js");
    const qref = query(collection(db,'ads'), where('ownerId','==', CURRENT_USER.uid), orderBy('createdAt','desc'));
    const snap = await getDocs(qref);
    if(snap.empty){ document.getElementById('my-ads').innerHTML = '<div class="muted">No ads</div>'; return; }
    let html = '<table class="table"><tr><th>ID</th><th>Target</th><th>Budget</th><th>Active</th><th>Actions</th></tr>';
    snap.forEach(d=>{
      const ad = d.data();
      html += `<tr><td>${d.id}</td><td style="max-width:300px;overflow:hidden">${ad.targetUrl}</td><td>${ad.budget_coins}</td><td>${ad.is_active}</td>
               <td><button data-id="${d.id}" class="btn-ghost btn-stop">Stop</button></td></tr>`;
    });
    html += '</table>';
    document.getElementById('my-ads').innerHTML = html;
    document.querySelectorAll('.btn-stop').forEach(b=> b.onclick = async (e)=> {
      const id = e.target.dataset.id; await updateDoc(doc(db,'ads',id), { is_active: false }); loadMyAds();
    });
  }

  loadMyAds();
}

/* ----------------- Auth listener + routing ----------------- */
onAuthStateChanged(auth, async (user) => {
  CURRENT_USER = user;
  // parse referral from query (e.g., ?ref=uid) store in localStorage for signups
  const params = new URLSearchParams(location.search);
  const refParam = params.get('ref');
  if(refParam){ localStorage.setItem('markcoin_ref', refParam); history.replaceState(null,'',location.pathname); }
  if(user){
    await ensureUserDoc(user); // create user doc if missing & handle inviter credit
    // set nav links visible (client-side)
    document.querySelectorAll('nav a').forEach(a => a.style.display = 'inline');
    route();
  } else {
    // hide inner pages links (they will redirect if not auth)
    document.querySelectorAll('nav a').forEach(a => { if(a.getAttribute('href').startsWith('#/')) a.style.display = 'none'; });
    route();
  }
});

window.addEventListener('hashchange', route);

/* Expose a small debug handle (optional) */
window.MARKCOIN = { app, auth, db, cfg: { webTrafficReward, directLinkReward } };

</script>
</body>
</html>
