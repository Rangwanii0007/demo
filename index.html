<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MARK COIN</title>
  <style>
    body{margin:0;background:#071124;color:#e6eef6;font-family:Arial,Helvetica,sans-serif;}
    header{display:flex;justify-content:space-between;align-items:center;background:#0b1220;padding:12px;}
    nav a{color:#94a3b8;margin-left:12px;text-decoration:none;font-size:14px}
    .brand{font-weight:700;color:#06b6d4}
    .btn{background:#06b6d4;color:#042027;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .card{background:#0b1220;padding:14px;border-radius:10px;margin:14px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    .muted{color:#94a3b8}
    iframe{width:100%;height:300px;border:0;border-radius:8px}
    .whatsapp-btn{color:#25D366;font-weight:bold;text-decoration:none;font-size:14px;display:flex;align-items:center;gap:6px;}
  </style>
</head>
<body>
  <header>
    <div class="brand">MARK COIN</div>
    <nav>
      <a href="#/dashboard">Dashboard</a>
      <a href="#/watch">Watch</a>
      <a href="#/ads">Launch Ad</a>
      <a href="#/ref">Referrals</a>
      <a href="https://wa.me/923330737987?text=Hi,%20I%20want%20Premium%20access" class="whatsapp-btn" target="_blank">üí¨ Want Premium?</a>
    </nav>
  </header>
  <div id="app"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import { getFirestore,doc,getDoc,updateDoc } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAnu49G3ZZaMhRAYwoBPKfcRoj7sfcu5E8",
      authDomain: "ad-4-u.firebaseapp.com",
      projectId: "ad-4-u",
      storageBucket: "ad-4-u.firebasestorage.app",
      messagingSenderId: "775864010731",
      appId: "1:775864010731:web:ea8a2ff4f772ca80ac3bae",
      measurementId: "G-3R9DDSM2XK"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const appDiv = document.getElementById("app");

    function renderDashboard(user, data){
      appDiv.innerHTML = `
        <div class="card">
          <h2>Welcome ${data.displayName || user.email}</h2>
          <p class="muted">Role: ${data.role}</p>
          <p class="muted">Coins: ${data.coins?.usable || 0}</p>
          ${data.role === "premium" ? `<p>‚≠ê Premium active until: ${data.premiumExpiresAt?.toDate?.() || "?"}</p>` : ""}
          <button class="btn" id="logout">Sign Out</button>
        </div>
      `;
      document.getElementById("logout").onclick = ()=>signOut(auth);
    }

    async function checkUser(user){
      const ref = doc(db,"users",user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){ appDiv.innerHTML="<div class='card'>No user doc</div>"; return; }
      let data = snap.data();

      // Auto downgrade if expired
      if(data.role==="premium" && data.premiumExpiresAt && data.premiumExpiresAt.toDate()<new Date()){
        await updateDoc(ref,{role:"free",premiumExpiresAt:null});
        data.role="free";
      }
      renderDashboard(user,data);
    }

    onAuthStateChanged(auth,(user)=>{
      if(user) checkUser(user);
      else appDiv.innerHTML = "<div class='card'>Please login/signup</div>";
    });
  </script>
</body>
</html>
